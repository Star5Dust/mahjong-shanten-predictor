# 日麻向听数预测模型（Mahjong Shanten Predictor）

基于天凤牌谱训练的对手向听状态预测模型。  
目标：仅通过公开信息（打牌、副露、宝牌等），判断任意非己方玩家当前是否处于 **听牌（0）**、**1 向听（1）** 或 **安全状态（2+）**。

---

## 📊 数据规模

| 项目 | 数值 |
|------|------|
| **来源** | Kaggle "tenhou-to-mjai" 数据集 |
| **时间** | 2024 年 1 月 |
| **原始对局** | 100 局（.mjson） |
| **生成样本** | 48,214 条（每局 ~480 个打牌时刻） |
| **存储格式** | Parquet（按小局分片，共 1059 个文件） |

### 目标扩展
- **中期**：10,000 局 → ~480 万样本
- **全量**：927,039 局 → ~4.6 亿样本

---

## ⚙️ 技术特点

- **标签生成**：由 `mahjong.shanten.Shanten` 计算真实向听数，归为三类：`0`（听牌）、`1`（1 向听）、`2+`（安全）
- **输入特征**：
  - 舍牌序列（最大 40 巡，含赤宝牌）
  - 副露次数（吃/碰/杠统计）
  - 位置编码（区分巡目）
- **数据划分**：按完整小局（Kyoku）划分训练/验证集，避免同一对局跨集合泄露
- **模型架构**：Transformer Encoder + 全局池化 + 三分类头

---

## 📁 项目结构

shanten/
├── data_preprocessing/
│ ├── mjson2parquet_100.py # 牌谱解析脚本
│ └── test_100mjson/ # Parquet 输出 (1059 文件)
├── transformer/
│ ├── train_test.py # 训练主脚本
│ ├── model_test.py # Transformer 模型定义
│ ├── load_dataset_test.py # 数据加载器
│ ├── checkpoints/ # 模型权重
│ └── logs/ # TensorBoard 日志
└── README.md


---

## 📈 当前实验结果（Baseline）

**数据量**：4.8 万样本（100 局）

| 指标 | 数值 | 基准 | 评价 |
|:---|:---:|:---:|:---|
| **Accuracy** | **67.0%** | 33% | ✅ 有效学习 |
| **Macro F1** | **63.0%** | 33% | ⚠️ 类别不平衡 |
| **听牌召回率** | **54.0%** | 33% | ⚠️ 漏检 46% |
| **1 向听 F1** | **52.0%** | 33% | ❌ 最难识别 |

